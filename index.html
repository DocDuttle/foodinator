<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Was gibt's zum Essen?</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="fancy-fonts.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-gray-100 to-white min-h-screen p-4 overflow-x-hidden flex justify-center">
  <!-- Login Form -->
  <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-90 z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-xs flex flex-col items-center">
      <h2 class="text-xl font-semibold mb-4 text-blue-700">Login</h2>
      <input id="login-username" type="text" placeholder="Benutzername" class="w-full mb-4 p-2 border rounded" />
      <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Login</button>
    </div>
  </div>
  <!-- Customization Screen -->
  <div id="customize-screen" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-95 z-50 hidden overflow-y-auto">
    <div class="bg-white p-0 rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-y-auto">
      <div class="sticky top-0 z-10 bg-white p-6 pb-2 rounded-t-xl">
        <h2 class="text-xl font-semibold mb-4 text-blue-700">Men√º anpassen</h2>
      </div>
      <form id="customize-form" class="flex-1 flex flex-col px-6 pb-2 overflow-y-auto">
        <div class="mb-4">
          <h3 class="font-bold mb-2">Hauptgang</h3>
          <div id="customize-hauptgang" class="grid grid-cols-2 gap-2 min-h-[6rem]"></div>
        </div>
        <div class="mb-4">
          <h3 class="font-bold mb-2">Beilage</h3>
          <div id="customize-beilage" class="grid grid-cols-2 gap-2 min-h-[6rem]"></div>
        </div>
        <div class="mb-4">
          <h3 class="font-bold mb-2">Gem√ºse</h3>
          <div id="customize-gemuese" class="grid grid-cols-2 gap-2 min-h-[6rem]"></div>
        </div>
        <div class="mb-4">
          <h3 class="font-bold mb-2">Dessert</h3>
          <div id="customize-dessert" class="grid grid-cols-2 gap-2 min-h-[6rem]"></div>
        </div>
        <div class="flex gap-2 mt-6 sticky bottom-0 bg-white py-2">
          <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Speichern</button>
          <button type="button" id="customize-cancel" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">Zur√ºck</button>
        </div>
        <button type="button" id="customize-scrolltop" class="w-full mt-2 mb-2 text-blue-500 underline text-sm">Nach oben</button>
      </form>
    </div>
  </div>
  <div class="w-full max-w-xl bg-white shadow-xl rounded-xl p-4 sm:p-6 overflow-x-hidden min-h-[38rem]">
    <button id="logout-btn" class="absolute top-4 right-4 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hidden">Logout</button>
    <!-- Professional Header Card -->
    <div class="menu-header-card">
      <div class="menu-header-badge">Foodinator</div>
      <div class="menu-header-content">
        <span class="menu-header-emoji">üçΩÔ∏è</span>
        <h1 class="menu-header-title">Was gibt's zum Essen?</h1>
        <p class="menu-header-subtitle">Weil ‚ÄûIch wei√ü nicht‚Ä¶‚Äú keine Mahlzeit ist.</p>
      </div>
    </div>
    <button id="customize-btn" class="w-full mb-4 bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded font-semibold hidden">Men√º anpassen</button>

    <!-- Enhanced Status Tracker -->
    <div id="status-tracker" class="flex justify-between items-center mb-6">
      <div class="flex-1 flex flex-col items-center">
        <div id="status-hauptgang" class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-500">1</div>
        <span class="text-xs mt-1">Hauptgang</span>
      </div>
      <div class="flex-1 h-1 bg-blue-200 mx-1"></div>
      <div class="flex-1 flex flex-col items-center">
        <div id="status-beilage" class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-200">2</div>
        <span class="text-xs mt-1">Beilage</span>
      </div>
      <div class="flex-1 h-1 bg-blue-200 mx-1"></div>
      <div class="flex-1 flex flex-col items-center">
        <div id="status-gemuese" class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-200">3</div>
        <span class="text-xs mt-1">Gem√ºse</span>
      </div>
      <div class="flex-1 h-1 bg-blue-200 mx-1"></div>
      <div class="flex-1 flex flex-col items-center">
        <div id="status-dessert" class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-200">4</div>
        <span class="text-xs mt-1">Dessert</span>
      </div>
    </div>

    <div id="step-hauptgang" class="step">
      <h2 class="text-xl font-medium text-gray-700">1. Hauptgang w√§hlen</h2>
      <div id="hauptgang-grid" class="menu-grid grid grid-cols-3 gap-4 gap-y-6 mt-4 min-h-[20rem]"></div>
    </div>

    <div id="step-beilage" class="step hidden">
      <h2 class="text-xl font-medium text-gray-700">2. Beilage w√§hlen</h2>
      <button id="back-beilage" class="mb-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded" onclick="goBack('hauptgang')">‚Üê Zur√ºck</button>
      <div id="beilage-grid" class="menu-grid grid grid-cols-3 gap-4 gap-y-6 mt-4 min-h-[20rem]"></div>
    </div>

    <div id="step-gemuese" class="step hidden">
      <h2 class="text-xl font-medium text-gray-700">3. Gem√ºse w√§hlen</h2>
      <button id="back-gemuese" class="mb-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded" onclick="goBack('beilage')">‚Üê Zur√ºck</button>
      <div id="gemuese-grid" class="menu-grid grid grid-cols-3 gap-4 gap-y-6 mt-4 min-h-[20rem]"></div>
    </div>

    <div id="step-dessert" class="step hidden">
      <h2 class="text-xl font-medium text-gray-700">4. Dessert w√§hlen</h2>
      <button id="back-dessert" class="mb-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded" onclick="goBack('gemuese')">‚Üê Zur√ºck</button>
      <div id="dessert-grid" class="menu-grid grid grid-cols-3 gap-4 gap-y-6 mt-4 min-h-[20rem]"></div>
    </div>

    <div id="step-summary" class="step hidden">
      <h2 class="text-xl font-medium text-gray-700">Dein Men√º</h2>
      <div id="summary" class="bg-blue-50 p-4 mt-4 rounded-lg shadow"></div>
    </div>
  </div>

  <script src="data.js"></script>
  <script>
    const auswahl = {};
    let favorites = [];

    function getKidStars(n) {
      return '‚≠ê'.repeat(n);
    }

    function filterBeilage(hauptgang) {
      if (!hauptgang || !hauptgang.pairs_with_tags) return lebensmittel.beilage;
      // Only show sides with tags matching the main's pairs_with_tags
      return lebensmittel.beilage.filter(b => b.tags && b.tags.some(t => hauptgang.pairs_with_tags.includes(t)));
    }

    function getRandomMenu() {
      // Only choose compatible menu
      let hauptgang = lebensmittel.hauptgang[Math.floor(Math.random() * lebensmittel.hauptgang.length)];
      let beilageOptions = filterBeilage(hauptgang);
      let beilage = beilageOptions.length ? beilageOptions[Math.floor(Math.random() * beilageOptions.length)] : null;
      let gemuese = lebensmittel.gemuese[Math.floor(Math.random() * lebensmittel.gemuese.length)];
      let dessert = lebensmittel.dessert[Math.floor(Math.random() * lebensmittel.dessert.length)];
      return { hauptgang, beilage, gemuese, dessert };
    }

    function createCards(items, gridId, nextStep, key, filterFn) {
      // --- Bulletproof single-row fix: apply .single-row if only one row
      setTimeout(() => {
        const grid = document.getElementById(gridId);
        if (grid) {
          grid.classList.remove('single-row');
          // On desktop, grid is max 4 columns. If items < 4, force flex fallback.
          if (items.length < 4) {
            grid.classList.add('single-row');
          }
        }
      }, 0);
      const container = document.getElementById(gridId).parentElement;
      let searchInput = container.querySelector('input');
      if (!searchInput) {
        searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = 'Suche...';
        searchInput.className = 'search-input w-full p-2 mt-2 mb-4 border border-gray-300 rounded';
        container.insertBefore(searchInput, container.children[1]);
      }
      // Enhanced search with debouncing
      if (!searchInput.hasListener) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            createCards(items, gridId, nextStep, key, filterFn);
          }, 300);
        });
        searchInput.hasListener = true;
      }
      // Add "Surprise Me!" button
      let surpriseBtn = container.querySelector('.surprise-btn');
      if (!surpriseBtn) {
        surpriseBtn = document.createElement('button');
        surpriseBtn.textContent = 'üé≤ √úberrasch mich!';
        surpriseBtn.className = 'surprise-btn mb-4 ml-2 bg-yellow-300 hover:bg-yellow-400 text-yellow-900 font-bold px-3 py-1 rounded shadow';
        surpriseBtn.onclick = () => {
          const randomMenu = getRandomMenu();
          auswahl.hauptgang = randomMenu.hauptgang;
          auswahl.beilage = randomMenu.beilage;
          auswahl.gemuese = randomMenu.gemuese;
          auswahl.dessert = randomMenu.dessert;
          showStep('summary');
          showSummary();
        };
        container.insertBefore(surpriseBtn, searchInput.nextSibling);
      }
      const grid = document.getElementById(gridId);
      grid.innerHTML = '';
      let filtered = items;
      if (filterFn) filtered = filtered.filter(filterFn);
      const query = searchInput && searchInput.value ? searchInput.value.toLowerCase() : '';
      if (query) {
        filtered = filtered.filter(item => item.name.toLowerCase().includes(query));
      }
      const sortedItems = filtered.slice().sort((a, b) => b.kid_friendly - a.kid_friendly);
      if (sortedItems.length === 0) {
        const msg = document.createElement('div');
        msg.className = 'text-center text-red-500 py-4';
        msg.textContent = 'Keine passenden Optionen gefunden.';
        grid.appendChild(msg);
        return;
      }
      sortedItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'menu-card bg-white border border-gray-200 rounded-lg p-4 text-center hover:shadow-lg transition-shadow cursor-pointer';
        card.innerHTML = `<span class='text-4xl mb-2 block w-full text-center'>${item.emoji}</span><span class='text-base font-semibold text-gray-800 block w-full break-words whitespace-normal text-center'>${item.name}</span>`;
        card.onclick = () => {
          // Add loading state
          card.classList.add('loading');
          setTimeout(() => {
            auswahl[key] = item;
            card.classList.remove('loading');
            card.classList.add('success-animation');
            setTimeout(() => {
              showStep(nextStep);
              if (nextStep === 'summary') {
                showSummary();
              }
            }, 300);
          }, 200);
        };
        grid.appendChild(card);
      });
    }

    function showStep(step) {
  // Add fade-out animation to current step
  const currentStep = document.querySelector('.step:not(.hidden)');
  if (currentStep) {
    currentStep.classList.add('fade-out');
    setTimeout(() => {
      document.querySelectorAll(".step").forEach(s => {
        s.classList.add("hidden");
        s.classList.remove('fade-out');
      });
      
      const newStep = document.getElementById(`step-${step}`);
      newStep.classList.remove("hidden");
      newStep.classList.add('fade-in');
      
      setTimeout(() => newStep.classList.remove('fade-in'), 300);
    }, 150);
  } else {
    document.querySelectorAll(".step").forEach(s => s.classList.add("hidden"));
    const newStep = document.getElementById(`step-${step}`);
    newStep.classList.remove("hidden");
    newStep.classList.add('fade-in');
    setTimeout(() => newStep.classList.remove('fade-in'), 300);
  }
  
  updateStatusTracker(step);
  // Scroll main container to top after step change
  const mainContainer = document.querySelector('.max-w-xl');
  if (mainContainer) mainContainer.scrollIntoView({behavior: 'smooth', block: 'start'});
  window.scrollTo({top: 0, behavior: 'smooth'});
  if (step === "beilage" && auswahl.hauptgang) {
        const beilageOptions = filterBeilage(auswahl.hauptgang);
        // If there are no matching Beilage, skip to Gem√ºse
        if (!auswahl.hauptgang.pairs_with_tags || auswahl.hauptgang.pairs_with_tags.length === 0 || beilageOptions.length === 0) {
          auswahl.beilage = null;
          showStep("gemuese");
          return;
        }
        createCards(beilageOptions, "beilage-grid", "gemuese", "beilage");
      } else if (step === "gemuese") {
        createCards(lebensmittel.gemuese, "gemuese-grid", "dessert", "gemuese");
      } else if (step === "dessert") {
        createCards(lebensmittel.dessert, "dessert-grid", "summary", "dessert");
      }
    }

    function goBack(prevStep) {
      if (prevStep === 'hauptgang') {
        auswahl.beilage = null;
        showStep('hauptgang');
      } else if (prevStep === 'beilage') {
        auswahl.gemuese = null;
        showStep('beilage');
      } else if (prevStep === 'gemuese') {
        auswahl.dessert = null;
        showStep('gemuese');
      }
    }

    function updateStatusTracker(currentStep) {
      const steps = ['hauptgang', 'beilage', 'gemuese', 'dessert'];
      steps.forEach((step, i) => {
        const el = document.getElementById('status-' + step);
        if (!el) return;
        if (steps.indexOf(currentStep) > i) {
          el.className = 'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-green-400';
        } else if (steps.indexOf(currentStep) === i) {
          el.className = 'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-500';
        } else {
          el.className = 'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-200';
        }
      });
    }

    function showSummary() {
  const s = auswahl;
  const html = `
    <div class="relative bg-white rounded-2xl shadow-2xl border-2 border-blue-200 max-w-md mx-auto px-6 py-8 mt-2 mb-2">
      <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-gradient-to-r from-blue-500 to-blue-300 text-white px-6 py-1 rounded-full shadow text-lg font-bold tracking-wide">Dein Men√º</div>
      <div class="flex flex-col gap-4 mt-6">
        <div class="flex items-center gap-4">
          <span class="text-3xl md:text-4xl">${s.hauptgang ? s.hauptgang.emoji : 'üçΩÔ∏è'}</span>
          <div>
            <div class="text-blue-700 font-semibold text-lg leading-tight">Hauptgang</div>
            <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.hauptgang ? s.hauptgang.name : ''}</div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-3xl md:text-4xl">${s.beilage ? s.beilage.emoji : 'ü•î'}</span>
          <div>
            <div class="text-blue-700 font-semibold text-lg leading-tight">Beilage</div>
            <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.beilage ? s.beilage.name : ''}</div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-3xl md:text-4xl">${s.gemuese ? s.gemuese.emoji : 'ü•¶'}</span>
          <div>
            <div class="text-blue-700 font-semibold text-lg leading-tight">Gem√ºse</div>
            <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.gemuese ? s.gemuese.name : ''}</div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-3xl md:text-4xl">${s.dessert ? s.dessert.emoji : 'üç®'}</span>
          <div>
            <div class="text-blue-700 font-semibold text-lg leading-tight">Dessert</div>
            <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.dessert ? s.dessert.name : ''}</div>
          </div>
        </div>
      </div>
      <div class="mt-8 flex flex-col items-center">
        <button onclick="restart()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-semibold shadow">Neu starten</button>
        <div class="mt-4 text-lg italic text-blue-500 font-pacifico">Bon App√©tit!</div>
      </div>
    </div>
  `;
  document.getElementById("summary").innerHTML = html;
}

function restart() {
  auswahl.hauptgang = null;
  auswahl.beilage = null;
  auswahl.gemuese = null;
  auswahl.dessert = null;
  showStep("hauptgang");
  updateStatusTracker('hauptgang');
}

function updateStatusTracker(currentStep) {
  const steps = ['hauptgang', 'beilage', 'gemuese', 'dessert'];
  steps.forEach((step, i) => {
    const el = document.getElementById('status-' + step);
    if (!el) return;
    
    if (steps.indexOf(currentStep) > i) {
      el.className = 'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-green-400';
    } else if (steps.indexOf(currentStep) === i) {
      el.className = 'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-500';
    } else {
      el.className = 'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold bg-blue-200';
    }
  });
}

  function showSummary() {
    const s = auswahl;
    const html = `
      <div class="relative bg-white rounded-2xl shadow-2xl border-2 border-blue-200 max-w-md mx-auto px-6 py-8 mt-2 mb-2">
        <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-gradient-to-r from-blue-500 to-blue-300 text-white px-6 py-1 rounded-full shadow text-lg font-bold tracking-wide">Dein Men√º</div>
        <div class="flex flex-col gap-4 mt-6">
          <div class="flex items-center gap-4">
            <span class="text-3xl md:text-4xl">${s.hauptgang ? s.hauptgang.emoji : 'üçΩÔ∏è'}</span>
            <div>
              <div class="text-blue-700 font-semibold text-lg leading-tight">Hauptgang</div>
              <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.hauptgang ? s.hauptgang.name : ''}</div>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-3xl md:text-4xl">${s.beilage ? s.beilage.emoji : 'ü•î'}</span>
            <div>
              <div class="text-blue-700 font-semibold text-lg leading-tight">Beilage</div>
              <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.beilage ? s.beilage.name : ''}</div>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-3xl md:text-4xl">${s.gemuese ? s.gemuese.emoji : 'ü•¶'}</span>
            <div>
              <div class="text-blue-700 font-semibold text-lg leading-tight">Gem√ºse</div>
              <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.gemuese ? s.gemuese.name : ''}</div>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-3xl md:text-4xl">${s.dessert ? s.dessert.emoji : 'üç®'}</span>
            <div>
              <div class="text-blue-700 font-semibold text-lg leading-tight">Dessert</div>
              <div class="text-gray-800 text-xl md:text-2xl font-bold">${s.dessert ? s.dessert.name : ''}</div>
            </div>
          </div>
        </div>
        <div class="mt-8 flex flex-col items-center">
          <button onclick="restart()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-semibold shadow">Neu starten</button>
          <div class="mt-4 text-lg italic text-blue-500 font-pacifico">Bon App√©tit!</div>
        </div>
      </div>
    `;
    document.getElementById("summary").innerHTML = html;
  }

  function restart() {
    auswahl.hauptgang = null;
    auswahl.beilage = null;
    auswahl.gemuese = null;
    auswahl.dessert = null;
    showStep("hauptgang");
    updateStatusTracker('hauptgang');
  }

  // --- Auth & Customization State ---
  const LS_USER_KEY = 'essenapp_user';
  const LS_ACTIVE_KEY = user => `essenapp_active_${user}`;

  function getUser() {
    return localStorage.getItem(LS_USER_KEY);
  }
  function setUser(u) {
    localStorage.setItem(LS_USER_KEY, u);
  }
  function removeUser() {
    localStorage.removeItem(LS_USER_KEY);
  }
  function getActiveMap() {
    const user = getUser();
    if (!user) return {};
    try {
      return JSON.parse(localStorage.getItem(LS_ACTIVE_KEY(user))) || {};
    } catch { return {}; }
  }
  function setActiveMap(map) {
    const user = getUser();
    if (!user) return;
    localStorage.setItem(LS_ACTIVE_KEY(user), JSON.stringify(map));
  }
  function isActive(type, idx) {
    const map = getActiveMap();
    if (!map[type]) return true;
    if (typeof map[type][idx] === 'boolean') return map[type][idx];
    return true;
  }

  // --- DOM helpers and utilities ---
  const toggleElement = (id, show) => document.getElementById(id).classList.toggle('hidden', !show);
  const showLogin = (show) => toggleElement('login-screen', show);
  const showCustomize = (show) => toggleElement('customize-screen', show);
  const showApp = (show) => document.querySelector('.max-w-xl').classList.toggle('hidden', !show);
  const showCustomizeBtn = (show) => toggleElement('customize-btn', show);
  const showLogoutBtn = (show) => toggleElement('logout-btn', show);
  
  // Event delegation utility
  const handleClick = (e) => {
    const handlers = {
      'login-btn': () => {
        const u = document.getElementById('login-username').value.trim();
        if (u) { setUser(u); checkLogin(); location.reload(); }
      },
      'logout-btn': () => { removeUser(); location.reload(); },
      'customize-btn': () => {
        populateCustomizeForm();
        showCustomize(true);
        setTimeout(() => {
          const customizeDiv = document.querySelector('#customize-screen > div.overflow-y-auto');
          if (customizeDiv) customizeDiv.scrollTo({top: 0, behavior: 'smooth'});
        }, 50);
      },
      'customize-cancel': () => showCustomize(false)
    };
    
    if (handlers[e.target.id]) {
      handlers[e.target.id]();
    }
  };

  // --- Login/logout logic ---
  function checkLogin() {
    const user = getUser();
    if (!user) {
      showLogin(true); showApp(false); showCustomizeBtn(false); showLogoutBtn(false);
    } else {
      showLogin(false); showApp(true); showCustomizeBtn(true); showLogoutBtn(true);
    }
  }
  // Use event delegation for cleaner code
  document.addEventListener('click', handleClick);
  document.getElementById('customize-form').onsubmit = function(e) {
    e.preventDefault();
    const map = { hauptgang: [], beilage: [], gemuese: [], dessert: [] };
    ['hauptgang','beilage','gemuese','dessert'].forEach(type => {
      const boxes = document.querySelectorAll(`#customize-${type} input[type=checkbox]`);
      boxes.forEach((cb,i) => { map[type][i] = cb.checked; });
    });
    setActiveMap(map);
    showCustomize(false);
    location.reload();
  };
  function populateCustomizeForm() {
    const map = getActiveMap();
    [
      ['hauptgang', lebensmittel.hauptgang],
      ['beilage', lebensmittel.beilage],
      ['gemuese', lebensmittel.gemuese],
      ['dessert', lebensmittel.dessert]
    ].forEach(([type, arr]) => {
      const cont = document.getElementById('customize-' + type);
      cont.innerHTML = '';
      arr.forEach((item, idx) => {
        const id = `cb-${type}-${idx}`;
        const checked = (map[type] === undefined || map[type][idx] === undefined) ? true : !!map[type][idx];
        cont.innerHTML += `<label class='flex items-start gap-2 bg-gray-50 rounded px-2 py-1 min-w-0 min-h-[2.25rem] w-full'><input type='checkbox' id='${id}' ${checked ? 'checked' : ''} class='mt-1'/> <span class='text-lg flex-shrink-0'>${item.emoji}</span> <span class='block w-full break-words whitespace-normal text-base'>${item.name}</span></label>`;
      });
    });
  }

  // --- Patch menu filtering (cards) ---
  document.addEventListener('DOMContentLoaded', function() {
    checkLogin();
    const origCreateCards = createCards;
    createCards = function(items, gridId, nextStep, key, filterFn) {
      let arrType = null;
      if (gridId.includes('hauptgang')) arrType = 'hauptgang';
      else if (gridId.includes('beilage')) arrType = 'beilage';
      else if (gridId.includes('gemuese')) arrType = 'gemuese';
      else if (gridId.includes('dessert')) arrType = 'dessert';
      let filtered = items;
      if (arrType) {
        filtered = items.filter((item, idx) => isActive(arrType, idx));
      }
      if (filterFn) filtered = filtered.filter(filterFn);
      return origCreateCards(filtered, gridId, nextStep, key, filterFn);
    };
    createCards(lebensmittel.hauptgang, "hauptgang-grid", "beilage", "hauptgang");
    // Nach oben button in customize menu
    const customizeScrollTopBtn = document.getElementById('customize-scrolltop');
    if (customizeScrollTopBtn) {
      customizeScrollTopBtn.onclick = function() {
        const customizeDiv = document.querySelector('#customize-screen > div.overflow-y-auto');
        if (customizeDiv) customizeDiv.scrollTo({top: 0, behavior: 'smooth'});
      };
    }
  });
</script>
</body>
</html>
